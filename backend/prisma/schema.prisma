generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int      @id @default(autoincrement())
  email             String   @unique
  password          String
  name              String?
  role              Role     @default(EMPLOYEE)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  ordenesEntregadas Orden[]  @relation("DeliveredBy")
}

model Cliente {
  id                  Int         @id @default(autoincrement())
  nombre              String
  apellido            String
  tipo                TipoCliente
  telefono            String
  telefono_secundario String?
  direccion           String
  identificacion      String      @unique
  email               String?
  fechaRegistro       DateTime    @default(now())
  ordenes             Orden[]
}

model Categoria {
  id        String     @id @default(uuid())
  nombre    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  servicios Servicio[]
}

model Servicio {
  id               Int            @id @default(autoincrement())
  nombreServicio   String
  descripcion      String?
  precioBase       Float
  permiteDecimales Boolean        @default(false)
  categoriaId      String
  detalleOrdenes   DetalleOrden[]
  categoria        Categoria      @relation(fields: [categoriaId], references: [id])

  @@index([categoriaId], map: "Servicio_categoriaId_fkey")
}

model Orden {
  id                  Int            @id @default(autoincrement())
  clienteId           Int
  estado              EstadoOrden    @default(PENDIENTE)
  fechaIngreso        DateTime       @default(now())
  fechaEntrega        DateTime?
  observaciones       String?
  total               Float
  abonado             Float          @default(0)
  faltante            Float          @default(0)
  estadoPago          EstadoPago     @default(INCOMPLETO)
  deliveredByUserId   Int?
  deliveredByUserName String?
  detalles            DetalleOrden[]
  cliente             Cliente        @relation(fields: [clienteId], references: [id])
  deliveredBy         User?          @relation("DeliveredBy", fields: [deliveredByUserId], references: [id])
  pagos               Pago[]

  @@index([clienteId])
  @@index([estado])
  @@index([deliveredByUserId])
}

model DetalleOrden {
  id         Int      @id @default(autoincrement())
  ordenId    Int
  servicioId Int
  cantidad   Float
  precioUnit Float
  subtotal   Float
  orden      Orden    @relation(fields: [ordenId], references: [id])
  servicio   Servicio @relation(fields: [servicioId], references: [id])

  @@index([ordenId], map: "DetalleOrden_ordenId_fkey")
  @@index([servicioId], map: "DetalleOrden_servicioId_fkey")
}

model Pago {
  id         Int               @id @default(autoincrement())
  ordenId    Int
  monto      Float
  moneda     Moneda
  metodoPago MetodoPago
  tasa       Decimal         @db.Decimal(10, 2) @default(0.00)
  nota       String?
  fechaPago  DateTime          @default(now())
  orden      Orden             @relation(fields: [ordenId], references: [id])
  vueltos    VueltoEntregado[]

  @@index([ordenId], map: "Pago_ordenId_fkey")
}

model VueltoEntregado {
  id     Int    @id @default(autoincrement())
  pagoId Int
  monto  Float
  moneda String
  pago   Pago   @relation(fields: [pagoId], references: [id], onDelete: Cascade)

  @@index([pagoId])
}

model Configuracion {
  id                 Int     @id @default(1)
  nombreNegocio      String?
  monedaPrincipal    Moneda  @default(USD)
  tasaUSD            Float?
  tasaVES            Float?
  tasaCOP            Float?
  rif                String?
  direccion          String?
  telefonoPrincipal  String?
  telefonoSecundario String?
  mensajePieRecibo   String?
}

enum TipoCliente {
  NATURAL
  EMPRESA
}

enum EstadoOrden {
  PENDIENTE
  ENTREGADO
}

enum MetodoPago {
  EFECTIVO
  TRANSFERENCIA
  PAGO_MOVIL
}

enum Moneda {
  USD
  VES
  COP
}

enum EstadoPago {
  COMPLETO
  INCOMPLETO
}

enum Role {
  ADMIN
  EMPLOYEE
}
